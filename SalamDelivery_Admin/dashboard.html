<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Salam Delivery | Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:'Poppins',sans-serif;
      background:#f5f5f5;
      color:#000;
    }
    a{text-decoration:none;color:inherit;}
    /* SIDEBAR */
    .sidebar{
      position:fixed;left:0;top:0;bottom:0;width:220px;
      background:#000;color:#FFD600;padding-top:15px;
    }
    .sidebar .logo{
      display:flex;align-items:center;gap:10px;
      padding:0 15px 10px;
    }
    .sidebar .logo-icon{
      width:34px;height:34px;border-radius:10px;
      background:#FFD600;color:#000;font-weight:700;
      display:flex;align-items:center;justify-content:center;
    }
    .sidebar .logo span{font-weight:700;font-size:15px;}
    .sidebar ul{list-style:none;margin-top:15px;}
    .sidebar li{
      padding:10px 18px;display:flex;align-items:center;gap:10px;
      cursor:pointer;font-size:13px;border-radius:8px;margin:4px 10px;
    }
    .sidebar li i{font-size:18px;}
    .sidebar li.active,.sidebar li:hover{
      background:#FFD600;color:#000;
    }

    /* HEADER */
    .header{
      position:fixed;left:220px;right:0;top:0;height:60px;
      background:#111;color:#FFD600;
      display:flex;align-items:center;justify-content:space-between;
      padding:0 18px;z-index:5;
    }
    .header-right{display:flex;align-items:center;gap:10px;}
    .header-right button{
      border:none;padding:6px 10px;border-radius:999px;
      background:#FFD600;color:#000;font-size:12px;cursor:pointer;
    }
    .header-right .avatar{
      width:30px;height:30px;border-radius:50%;background:#FFD600;
      display:flex;align-items:center;justify-content:center;
      color:#000;font-weight:700;font-size:14px;
    }
    .header-right .logout{
      background:#000;color:#FFD600;border:1px solid #FFD600;
      display:flex;align-items:center;justify-content:center;
    }

    /* MAIN */
    .main{
      margin-left:220px;padding:80px 25px 30px 25px;
    }
    .main h1{font-size:20px;margin-bottom:15px;}

    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:12px;margin-bottom:20px;
    }
    .card{
      padding:18px;border-radius:12px;text-align:left;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }
    .card h2{font-size:22px;margin-bottom:5px;}
    .card p{font-size:13px;}
    .card.yellow{background:#FFD600;color:#000;}
    .card.black{background:#000;color:#FFD600;}

    .table-card{
      background:#fff;border-radius:12px;padding:15px;
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
      margin-top:20px;
    }
    .table-card h2{font-size:16px;margin-bottom:8px;}
    .table-card table{width:100%;border-collapse:collapse;font-size:13px;}
    .table-card th,.table-card td{
      padding:8px;border-bottom:1px solid #eee;
    }
    .badge{
      padding:2px 6px;border-radius:999px;font-size:11px;
    }
    .badge-pending{background:#FFD600;color:#000;}
    .badge-transit{background:#000;color:#FFD600;}
    .badge-done{background:#c8e6c9;color:#1b5e20;}

    /* Toast */
    .toast{
      position:fixed;bottom:20px;right:20px;
      background:#222;color:#fff;padding:8px 14px;
      border-radius:999px;display:flex;align-items:center;gap:8px;
      font-size:13px;box-shadow:0 3px 12px rgba(0,0,0,0.4);
      opacity:0;transform:translateY(10px);pointer-events:none;
      transition:opacity .2s,transform .2s;
      z-index:50;
    }
    .toast.show{opacity:1;transform:translateY(0);pointer-events:auto;}
    .toast i{font-size:18px;}
  </style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="logo">
    <div class="logo-icon">S</div>
    <span>Salam Delivery</span>
  </div>
  <ul>
    <li class="active"><i class="bx bxs-dashboard"></i><span>Dashboard</span></li>
    <li onclick="go('orders.html')"><i class="bx bx-package"></i><span>Orders</span></li>
    <li onclick="go('drivers.html')"><i class="bx bx-car"></i><span>Drivers</span></li>
    <li onclick="go('vendors.html')"><i class="bx bx-store-alt"></i><span>Vendors</span></li>
    <li onclick="go('payments.html')"><i class="bx bx-wallet"></i><span>Payments</span></li>
    <li onclick="go('settings.html')"><i class="bx bx-cog"></i><span>Settings</span></li>
  </ul>
</div>

<!-- HEADER -->
<div class="header">
  <div></div>
  <div class="header-right">
    <button id="langBtn" onclick="toggleLang()">AR</button>
    <div class="avatar">AD</div>
    <button class="logout" onclick="logout()"><i class="bx bx-log-out"></i></button>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <h1 data-en="Dashboard Overview" data-ar="نظرة عامة على النظام">Dashboard Overview</h1>

  <div class="cards">
    <div class="card yellow">
      <h2 id="totalOrders">0</h2>
      <p data-en="Total Orders" data-ar="إجمالي الطلبات">Total Orders</p>
    </div>
    <div class="card black">
      <h2 id="activeDrivers">0</h2>
      <p data-en="Active Drivers" data-ar="السائقين النشطين">Active Drivers</p>
    </div>
    <div class="card yellow">
      <h2 id="vendorsCount">0</h2>
      <p data-en="Vendors" data-ar="المتاجر">Vendors</p>
    </div>
    <div class="card black">
      <h2 id="revenueTotal">AED 0</h2>
      <p data-en="Total Revenue" data-ar="إجمالي الإيرادات">Total Revenue</p>
    </div>
  </div>

  <div class="table-card">
    <h2 data-en="Recent Orders" data-ar="أحدث الطلبات">Recent Orders</h2>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th data-en="Pickup" data-ar="الاستلام">Pickup</th>
          <th data-en="Dropoff" data-ar="التسليم">Dropoff</th>
          <th data-en="Status" data-ar="الحالة">Status</th>
          <th data-en="Total" data-ar="الإجمالي">Total</th>
        </tr>
      </thead>
      <tbody id="recentBody"></tbody>
    </table>
  </div>
</div>

<div id="toast" class="toast">
  <i class="bx bx-info-circle"></i><span id="toastMsg"></span>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabaseUrl = "https://nfmaqndlsbizkafzhigd.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mbWFxbmRsc2JpemthZnpoaWdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMzU5NjUsImV4cCI6MjA3NzkxMTk2NX0.ILsyiRbVNlOjwFV3f4Yt5-RROBA2gwQ0J-oMPFlRRDc";
  const supabase = createClient(supabaseUrl, supabaseKey);

  const toast = document.getElementById("toast");
  const toastMsg = document.getElementById("toastMsg");
  function showToast(msg,type="info"){
    toastMsg.textContent = msg;
    toast.style.background = type==="error" ? "#b71c1c" : "#2e7d32";
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"),3000);
  }

  function go(page){ window.location.href = page; }

  async function logout(){
    await supabase.auth.signOut();
    window.location.href = "login.html";
  }

  function toggleLang(){
    const html = document.documentElement;
    const dir = html.getAttribute("dir") === "rtl" ? "ltr" : "rtl";
    html.setAttribute("dir", dir);
    document.body.style.direction = dir;
    const langBtn = document.getElementById("langBtn");
    if(langBtn) langBtn.textContent = dir === "rtl" ? "EN" : "AR";
    document.querySelectorAll("[data-en]").forEach(el=>{
      const en = el.getAttribute("data-en");
      const ar = el.getAttribute("data-ar") || en;
      el.textContent = dir === "rtl" ? ar : en;
    });
  }

  async function loadStats(){
    try{
      const { data: orders, error:oErr } = await supabase
        .from("orders").select("id,total_price,status,pickup_address,dropoff_address")
        .order("created_at",{ascending:false}).limit(5);
      if(oErr) throw oErr;
      document.getElementById("totalOrders").textContent = orders.length;

      let revenue = 0;
      const tbody = document.getElementById("recentBody");
      tbody.innerHTML = "";
      orders.forEach((o,idx)=>{
        revenue += o.total_price || 0;
        const tr = document.createElement("tr");
        const badgeClass = o.status==="Pending"?"badge badge-pending":
                           o.status==="In Transit"?"badge badge-transit":
                           "badge badge-done";
        tr.innerHTML = \`
          <td>\${idx+1}</td>
          <td>\${o.pickup_address || "-"}</td>
          <td>\${o.dropoff_address || "-"}</td>
          <td><span class="\${badgeClass}">\${o.status}</span></td>
          <td>AED \${(o.total_price||0).toFixed(2)}</td>
        \`;
        tbody.appendChild(tr);
      });
      document.getElementById("revenueTotal").textContent = "AED " + revenue.toFixed(2);

      const { data: drivers, error:dErr } = await supabase.from("drivers").select("id");
      if(!dErr) document.getElementById("activeDrivers").textContent = drivers.length;

      const { data: vendors, error:vErr } = await supabase.from("vendors").select("id");
      if(!vErr) document.getElementById("vendorsCount").textContent = vendors.length;
    }catch(e){
      console.error(e);
      showToast("Error loading stats","error");
    }
  }

  loadStats();
</script>
</body>
</html>
